---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { uniqBy, sortBy } from "lodash-es";

export async function getStaticPaths() {
  const seasons = await getCollection("seasons");
  return seasons.map(({ id }) => ({
    params: { season: id },
  }));
}

const { season: seasonStr } = Astro.params;

const season = parseInt(seasonStr);

const allSeasons = await getCollection("seasons");
const previousSeason = allSeasons.find(({ data: { id } }) => id === season - 1);
const nextSeason = allSeasons.find(({ data: { id } }) => id === season + 1);

const allRaces = await getCollection("results");
const seasonRaces = sortBy(
  uniqBy(
    allRaces.filter(
      ({ data: { season: raceSeason } }) => raceSeason === season
    ),
    ({ data: { country } }) => country
  ),
  ({ data: { round } }) => round
);
---

<Layout>
  <div class="mt-4 flex items-center gap-4">
    {
      previousSeason && (
        <a
          title="Previous season"
          class="text-2xl"
          href={`/seasons/${previousSeason.data.id}`}
        >
          ⏮︎
        </a>
      )
    }
    <h1>{season} season</h1>
    {
      nextSeason && (
        <a
          title="Next season"
          class="text-2xl"
          href={`/seasons/${nextSeason.data.id}`}
        >
          ⏭︎
        </a>
      )
    }
  </div>

  <div class="mt-4 grid grid-cols-2 md:grid-cols-4">
    {
      seasonRaces.map(({ data: { country, round } }) => (
        <a
          class={`block p-4 m-2 text-center bg-gray-200 rounded-md hover:bg-gray-300`}
          href={`/season/${season}/${round}`}
        >
          Round {round}: {country}
        </a>
      ))
    }
  </div>
</Layout>
